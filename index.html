<script>
//This runs in Sender IFrame
//Receives data from Sender and saves it in a Cookie
window.addEventListener("message", function(event){
	console.log("[Intermediate] Setting cookie: " + event.data);
	document.cookie = 'sender_message='+event.data+'; SameSite=None; Secure; expires=Sun, 1 Jan 2023 00:00:00 UTC; path=/'
});

//This runs in Receiver IFrame 
//Check for any changes in the Cookies and uses postMessage to send it to the receiver
window.onload = function() {
	var key = "sender_message=";
	var last_cookie = "";
	var intervalId = window.setInterval(function(){
		var cookies = document.cookie.split(';');
		cookies.forEach(c => {
			//trimStart because depending on Cookie position in array it may contain a space at the start
			if(c.trimStart().startsWith(key)) {
				var new_cookie = c.replace(key,"");
				if(last_cookie !== new_cookie) {
					last_cookie = new_cookie;
					console.log("[Intermediate] Found new Cookie, sending it trough postMessage: " + new_cookie);
					var win = window.parent[0];
					if(win && win.name === 'frame2') {
						top.postMessage(new_cookie, "*"); //Works locally
						window.parent.postMessage(new_cookie, "*"); //works in PEGA
					}
				}
			}
		});
	}, 100);
};
</script>

<p>Iframe</p>
